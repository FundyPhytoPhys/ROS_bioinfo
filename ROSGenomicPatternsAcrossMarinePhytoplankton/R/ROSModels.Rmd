---
title: "ROSModels"
output: html_document
---



```{r packages and paths, include = FALSE}
library(tidyverse)
# library(cowplot)
library(broom)
library(chngpt)
library(ggpubr)
# library(glue)
# library(smatr)
#https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html#installation

# library(kableExtra)
# options(kableExtra.auto_format = FALSE)
# library(rcompanion)
# library(corrplot)
library(knitr)
# library(PanVizGenerator)
# library(ggiraphExtra)
library(AER)
```

```{r assign filepaths, include = FALSE}
Figures <- file.path("..", "Figures")
DataIn <- file.path("..", "DataIn")
FigureMaterial <- file.path("..", "FigureMaterial")
DataProcessed <- file.path("..", "DataProcessed")
```

```{r read in data}
MergedData <- readRDS(file.path(DataProcessed, "MergedData.Rds"))
TaxaColors <- readRDS(file.path(DataProcessed, "TaxaColours.Rds"))
WideData <- readRDS(file.path(DataProcessed, "WideData.Rds"))
HyPeMerged <- readRDS(file.path(DataProcessed, "HyPeMerged.Rds"))
SupOxMerged <- readRDS(file.path(DataProcessed, "SupOxMerged.Rds"))
NitOxMerged <- readRDS(file.path(DataProcessed, "NitOxMerged.Rds"))
```

```{r threshold_type}
threshold_type = c("step")
```

# Radius {}

## HyPe {}

```{r HyPeRad, include = FALSE}
HyPeRad <- MergedData %>% 
  filter(Taxa != "Prokaryote",
         !is.na(HyPe)) %>%
  select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, HyPe, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, HyPe_count, Phylum) %>%
  unique() %>%
  filter(GeneModels_count != 0) %>% #This is because of introducing exposure
  nest(data = -HyPe) %>%
  mutate(fit_p_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_offset = map(fit_p_offset, tidy),
                    pred_p_offset = map(fit_p_offset, augment),
                    qual_p_offset = map(fit_p_offset, glance),
                    dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
                    dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
         fit_qp_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_offset = map(fit_qp_offset, tidy),
                    pred_qp_offset = map(fit_qp_offset, augment),
                    qual_qp_offset = map(fit_qp_offset, glance),
                    offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
                    offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
                    offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
                    offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
                    offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
         fit_p_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
                    pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
                    qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
                    dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
                    dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
         fit_qp_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
                    pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
                    qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
                    taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
                    taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
                    taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
                    taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
                    taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
         fit_p_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
                    pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
                    qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
                    dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
                    dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
         fit_qp_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
                    pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
                    qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
                    taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
                    taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
                    taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
                    taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
                    taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
         fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
                    pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
                    qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
                    dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
                    dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
         fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
                    pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
                    qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
                    taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
  select(HyPe, data,
         offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
         taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
         taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
         taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
         # fit_chngpt = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ log_Radius_um,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt = map(fit_chngpt, "coefficients"),
         #            qual_chngpt = map(fit_chngpt, "vcov"),
         # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
         #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
         #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
         #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
         # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
         #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
         #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
         #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
         #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
         # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
         #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
         #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
         #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
         #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))

saveRDS(HyPeRad, file = file.path(DataProcessed, "HyPeRad.Rds"))
```

```{r HyPeRadNoZero, include = FALSE}
HyPeRadNoZero <- MergedData %>% 
  filter(Taxa != "Prokaryote",
         !is.na(HyPe), 
         HyPe_count != 0) %>%
  select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, HyPe, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, HyPe_count, Phylum)  %>%
  unique() %>%
  filter(GeneModels_count != 0)%>% #This is because of introducing exposure
  nest(data = -HyPe) %>%
  mutate(fit_p_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_offset = map(fit_p_offset, tidy),
                    pred_p_offset = map(fit_p_offset, augment),
                    qual_p_offset = map(fit_p_offset, glance),
                    dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
                    dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
         fit_qp_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_offset = map(fit_qp_offset, tidy),
                    pred_qp_offset = map(fit_qp_offset, augment),
                    qual_qp_offset = map(fit_qp_offset, glance),
                    offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
                    offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
                    offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
                    offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
                    offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
         fit_p_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
                    pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
                    qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
                    dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
                    dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
         fit_qp_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
                    pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
                    qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
                    taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
                    taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
                    taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
                    taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
                    taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
         fit_p_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
                    pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
                    qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
                    dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
                    dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
         fit_qp_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
                    pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
                    qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
                    taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
                    taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
                    taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
                    taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
                    taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
         fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
                    pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
                    qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
                    dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
                    dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
         fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
                    pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
                    qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
                    taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
  select(HyPe, data,
         offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
         taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
         taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
         taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)

         # fit_chngpt = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ log_Radius_um,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt = map(fit_chngpt, "coefficients"),
         #            qual_chngpt = map(fit_chngpt, "vcov"),
         # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
         #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
         #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
         #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
         # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
         #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
         #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
         #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
         #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
         # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
         #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
         #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
         #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
         #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))


saveRDS(HyPeRadNoZero, file = file.path(DataProcessed, "HyPeRadNoZero.Rds"))
```


```{r HyPeRadProk, include = FALSE}
HyPeRadProk <- MergedData %>% 
  filter(!is.na(HyPe)) %>%
  filter(GeneModels_count != 0)%>% #This is because of introducing exposure
  select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, HyPe, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, HyPe_count, Phylum)  %>%
  unique() %>%
  nest(data = -HyPe) %>%
  mutate(fit_p_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_offset = map(fit_p_offset, tidy),
                    pred_p_offset = map(fit_p_offset, augment),
                    qual_p_offset = map(fit_p_offset, glance),
                    dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
                    dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
         fit_qp_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_offset = map(fit_qp_offset, tidy),
                    pred_qp_offset = map(fit_qp_offset, augment),
                    qual_qp_offset = map(fit_qp_offset, glance),
                    offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
                    offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
                    offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
                    offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
                    offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
         fit_p_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
                    pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
                    qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
                    dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
                    dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
         fit_qp_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
                    pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
                    qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
                    taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
                    taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
                    taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
                    taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
                    taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
         fit_p_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
                    pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
                    qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
                    dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
                    dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
         fit_qp_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
                    pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
                    qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
                    taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
                    taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
                    taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
                    taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
                    taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
         fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
                    pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
                    qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
                    dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
                    dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
         fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
                    pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
                    qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
                    taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
  select(HyPe, data,
         offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
         taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
         taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
         taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)

         # fit_chngpt = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ log_Radius_um,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt = map(fit_chngpt, "coefficients"),
         #            qual_chngpt = map(fit_chngpt, "vcov"),
         # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
         #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
         #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
         #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
         # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
         #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
         #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
         #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
         #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
         # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
         #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
         #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
         #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
         #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))

saveRDS(HyPeRadProk, file = file.path(DataProcessed, "HyPeRadProk.Rds"))
```

## SupOx {}
```{r SupOxRad, include = FALSE}
SupOxRad <- MergedData %>% 
  filter(Taxa != c("Prokaryote"),
         !is.na(SupOx)) %>%
  filter(GeneModels_count != 0)%>% #This is because of introducing exposure
  select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, SupOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, SupOx_count, ColonySpecies, Phylum)  %>%
  unique() %>%
  nest(data = -SupOx) %>%
  mutate(fit_p_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_offset = map(fit_p_offset, tidy),
                    pred_p_offset = map(fit_p_offset, augment),
                    qual_p_offset = map(fit_p_offset, glance),
                    dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
                    dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
         fit_qp_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_offset = map(fit_qp_offset, tidy),
                    pred_qp_offset = map(fit_qp_offset, augment),
                    qual_qp_offset = map(fit_qp_offset, glance),
                    offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
                    offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
                    offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
                    offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
                    offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
         fit_p_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
                    pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
                    qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
                    dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
                    dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
         fit_qp_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
                    pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
                    qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
                    taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
                    taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
                    taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
                    taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
                    taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
         fit_p_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
                    pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
                    qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
                    dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
                    dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
         fit_qp_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
                    pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
                    qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
                    taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
                    taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
                    taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
                    taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
                    taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
         fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
                    pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
                    qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
                    dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
                    dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
         fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
                    pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
                    qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
                    taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
  select(SupOx, data,
         offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
         taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
         taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
         taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
         # fit_chngpt = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ log_Radius_um,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt = map(fit_chngpt, "coefficients"),
         #            qual_chngpt = map(fit_chngpt, "vcov"),
         # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
         #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
         #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
         #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
         # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
         #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
         #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
         #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
         #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
         # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
         #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
         #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
         #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
         #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))

saveRDS(SupOxRad, file = file.path(DataProcessed, "SupOxRad.Rds"))
```

```{r SupOxRadNoZero, include = FALSE}
SupOxRadNoZero <- MergedData %>% 
  filter(Taxa != c("Prokaryote"),
         !is.na(SupOx), 
         SupOx_count != 0) %>%
  filter(GeneModels_count != 0)%>% #This is because of introducing exposure
  select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, SupOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, SupOx_count, Phylum)  %>%
  unique() %>%
  nest(data = -SupOx) %>%
  mutate(fit_p_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_offset = map(fit_p_offset, tidy),
                    pred_p_offset = map(fit_p_offset, augment),
                    qual_p_offset = map(fit_p_offset, glance),
                    dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
                    dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
         fit_qp_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_offset = map(fit_qp_offset, tidy),
                    pred_qp_offset = map(fit_qp_offset, augment),
                    qual_qp_offset = map(fit_qp_offset, glance),
                    offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
                    offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
                    offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
                    offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
                    offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
         fit_p_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
                    pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
                    qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
                    dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
                    dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
         fit_qp_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
                    pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
                    qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
                    taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
                    taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
                    taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
                    taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
                    taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
         fit_p_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
                    pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
                    qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
                    dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
                    dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
         fit_qp_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
                    pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
                    qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
                    taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
                    taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
                    taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
                    taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
                    taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
         fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
                    pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
                    qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
                    dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
                    dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
         fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
                    pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
                    qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
                    taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
  select(SupOx, data,
         offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
         taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
         taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
         taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
         # fit_chngpt = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ log_Radius_um,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt = map(fit_chngpt, "coefficients"),
         #            qual_chngpt = map(fit_chngpt, "vcov"),
         # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
         #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
         #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
         #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
         # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
         #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
         #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
         #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
         #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
         # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
         #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
         #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
         #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
         #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))


saveRDS(SupOxRadNoZero, file = file.path(DataProcessed, "SupOxRadNoZero.Rds"))
```

```{r SupOxRadProk, include = FALSE}
SupOxRadProk <- MergedData %>% 
  filter(!is.na(SupOx)) %>%
  filter(GeneModels_count != 0)%>% #This is because of introducing exposure
  select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, SupOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, SupOx_count, Phylum)  %>%
  unique() %>%
  nest(data = -SupOx) %>%
  mutate(fit_p_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_offset = map(fit_p_offset, tidy),
                    pred_p_offset = map(fit_p_offset, augment),
                    qual_p_offset = map(fit_p_offset, glance),
                    dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
                    dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
         fit_qp_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_offset = map(fit_qp_offset, tidy),
                    pred_qp_offset = map(fit_qp_offset, augment),
                    qual_qp_offset = map(fit_qp_offset, glance),
                    offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
                    offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
                    offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
                    offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
                    offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
         fit_p_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
                    pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
                    qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
                    dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
                    dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
         fit_qp_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
                    pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
                    qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
                    taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
                    taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
                    taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
                    taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
                    taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
         fit_p_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
                    pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
                    qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
                    dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
                    dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
         fit_qp_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
                    pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
                    qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
                    taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
                    taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
                    taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
                    taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
                    taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
         fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
                    pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
                    qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
                    dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
                    dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
         fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
                    pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
                    qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
                    taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
  select(SupOx, data,
         offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
         taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
         taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
         taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
         # fit_chngpt = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ log_Radius_um,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt = map(fit_chngpt, "coefficients"),
         #            qual_chngpt = map(fit_chngpt, "vcov"),
         # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
         #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
         #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
         #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
         # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
         #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
         #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
         #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
         #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
         # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
         #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
         #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
         #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
         #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))

saveRDS(SupOxRadProk, file = file.path(DataProcessed, "SupOxRadProk.Rds"))
```


## NitOx {}

```{r NitOxRad, include = FALSE}
NitOxRad <- MergedData %>% 
  filter(Taxa != c("Prokaryote"),
         !is.na(NitOx)) %>%
  filter(GeneModels_count != 0)%>% #This is because of introducing exposure
  select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, NitOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, NitOx_count, Phylum)  %>%
  unique() %>%
  nest(data = -NitOx) %>%
  mutate(fit_p_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_offset = map(fit_p_offset, tidy),
                    pred_p_offset = map(fit_p_offset, augment),
                    qual_p_offset = map(fit_p_offset, glance),
                    dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
                    dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
         fit_qp_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_offset = map(fit_qp_offset, tidy),
                    pred_qp_offset = map(fit_qp_offset, augment),
                    qual_qp_offset = map(fit_qp_offset, glance),
                    offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
                    offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
                    offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
                    offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
                    offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
         fit_p_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
                    pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
                    qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
                    dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
                    dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
         fit_qp_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
                    pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
                    qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
                    taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
                    taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
                    taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
                    taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
                    taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
         fit_p_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
                    pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
                    qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
                    dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
                    dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
         fit_qp_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
                    pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
                    qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
                    taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
                    taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
                    taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
                    taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
                    taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
         fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
                    pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
                    qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
                    dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
                    dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
         fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
                    pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
                    qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
                    taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
  select(NitOx, data,
         offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
         taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
         taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
         taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)     
         # fit_chngpt = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ log_Radius_um,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt = map(fit_chngpt, "coefficients"),
         #            qual_chngpt = map(fit_chngpt, "vcov"),
         # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
         #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
         #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
         #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
         # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
         #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
         #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
         #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
         #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
         # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
         #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
         #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
         #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
         #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))

saveRDS(NitOxRad, file = file.path(DataProcessed, "NitOxRad.Rds"))
```

```{r NitOxRadNoZero, include = FALSE}
NitOxRadNoZero <- MergedData %>% 
  filter(Taxa != c("Prokaryote"),
         !is.na(NitOx), 
         NitOx_count != 0) %>%
  filter(GeneModels_count != 0)%>% #This is because of introducing exposure
  select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, NitOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, NitOx_count, Phylum)  %>%
  unique() %>%
  nest(data = -NitOx) %>%
  mutate(fit_p_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_offset = map(fit_p_offset, tidy),
                    pred_p_offset = map(fit_p_offset, augment),
                    qual_p_offset = map(fit_p_offset, glance),
                    dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
                    dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
         fit_qp_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_offset = map(fit_qp_offset, tidy),
                    pred_qp_offset = map(fit_qp_offset, augment),
                    qual_qp_offset = map(fit_qp_offset, glance),
                    offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
                    offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
                    offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
                    offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
                    offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
         fit_p_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
                    pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
                    qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
                    dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
                    dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
         fit_qp_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
                    pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
                    qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
                    taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
                    taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
                    taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
                    taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
                    taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
         fit_p_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
                    pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
                    qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
                    dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
                    dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
         fit_qp_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
                    pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
                    qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
                    taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
                    taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
                    taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
                    taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
                    taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
         fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
                    pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
                    qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
                    dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
                    dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
         fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
                    pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
                    qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
                    taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
  select(NitOx, data,
         offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
         taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
         taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
         taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)   

         # fit_chngpt = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ log_Radius_um,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt = map(fit_chngpt, "coefficients"),
         #            qual_chngpt = map(fit_chngpt, "vcov"),
         # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
         #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
         #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
         #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
         # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
         #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
         #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
         #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
         #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
         # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
         #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
         #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
         #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
         #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))

saveRDS(NitOxRadNoZero, file = file.path(DataProcessed, "NitOxRadNoZero.Rds"))
```

```{r NitOxRadProk, include = FALSE}
NitOxRadProk <- MergedData %>% 
  filter(!is.na(NitOx)) %>%
  filter(GeneModels_count != 0)%>% #This is because of introducing exposure
  select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, NitOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, NitOx_count, Phylum)  %>%
  unique() %>%
  nest(data = -NitOx) %>%
  mutate(fit_p_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_offset = map(fit_p_offset, tidy),
                    pred_p_offset = map(fit_p_offset, augment),
                    qual_p_offset = map(fit_p_offset, glance),
                    dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
                    dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
         fit_qp_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_offset = map(fit_qp_offset, tidy),
                    pred_qp_offset = map(fit_qp_offset, augment),
                    qual_qp_offset = map(fit_qp_offset, glance),
                    offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
                    offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
                    offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
                    offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
                    offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
         fit_p_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
                    pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
                    qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
                    dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
                    dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
         fit_qp_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
                    pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
                    qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
                    taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
                    taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
                                                        map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
                    taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
                    taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
                    taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
         fit_p_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
                    pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
                    qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
                    dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
                    dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
         fit_qp_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
                    pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
                    qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
                    taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
                    taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
                                                        map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
                    taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
                    taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
                    taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
         fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
                    param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
                    pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
                    qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
                    dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
                    dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
         fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$log_Radius_um + Phylum + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
                    param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
                    pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
                    qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
                    taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
                    taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
                                                        map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
                                                        map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
                    taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
                                                    map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
  select(NitOx, data,
         offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
         taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
         taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
         taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue) 

         # fit_chngpt = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ log_Radius_um,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt = map(fit_chngpt, "coefficients"),
         #            qual_chngpt = map(fit_chngpt, "vcov"),
         # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
         #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
         #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
         #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
         #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
         # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
         #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
         #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
         #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
         #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
         # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (log_Radius_um+Phylum),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
         #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
         #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
         #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
         #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))

saveRDS(NitOxRadProk, file = file.path(DataProcessed, "NitOxRadProk.Rds"))
```

# Latitude {}

## HyPe {}

```{r HyPeLat, include = FALSE}
# HyPeLat <- MergedData %>% 
#   filter(Taxa != c("Prokaryote"),
#          !is.na(HyPe)) %>%
#   filter(GeneModels_count != 0)%>% 
#   select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, HyPe, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, HyPe_count)  %>%
#   unique() %>%
#   nest(data = -HyPe) %>%
#   mutate(fit_p_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_offset = map(fit_p_offset, tidy),
#                     pred_p_offset = map(fit_p_offset, augment),
#                     qual_p_offset = map(fit_p_offset, glance),
#                     dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
#                     dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
#          fit_qp_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_offset = map(fit_qp_offset, tidy),
#                     pred_qp_offset = map(fit_qp_offset, augment),
#                     qual_qp_offset = map(fit_qp_offset, glance),
#                     offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
#                     offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
#                     offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
#                     offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
#                     offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
#          fit_p_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
#                     pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
#                     qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
#                     dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
#                     dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
#          fit_qp_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
#                     pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
#                     qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
#                     taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
#                     taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
#                     taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
#                     taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
#                     taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
#          fit_p_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
#                     pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
#                     qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
#                     dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
#                     dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
#          fit_qp_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
#                     pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
#                     qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
#                     taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
#                     taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
#                     taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
#                     taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
#                     taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
#          fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
#                     pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
#                     qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
#                     dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
#                     dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
#          fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
#                     pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
#                     qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
#                     taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
#   select(HyPe, data,
#          offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
#          taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
#          taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
#          taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
#          # fit_chngpt = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ abs_Latitude,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt = map(fit_chngpt, "coefficients"),
#          #            qual_chngpt = map(fit_chngpt, "vcov"),
#          # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
#          #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
#          #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
#          #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
#          # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
#          #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
#          #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
#          #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
#          # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
#          #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
#          #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
#          #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))
# 
# saveRDS(HyPeLat, file = file.path(DataProcessed, "HyPeLat.Rds"))

```

```{r HyPeLatNoZero, include = FALSE}
# HyPeLatNoZero <- MergedData %>% 
#   filter(Taxa != c("Prokaryote"),
#          !is.na(HyPe), 
#          HyPe_count != 0) %>%
#   filter(GeneModels_count != 0)%>% #This is because of introducing exposure
#   select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, HyPe, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, HyPe_count)  %>%
#   unique() %>%
#   nest(data = -HyPe) %>%
#   mutate(fit_p_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_offset = map(fit_p_offset, tidy),
#                     pred_p_offset = map(fit_p_offset, augment),
#                     qual_p_offset = map(fit_p_offset, glance),
#                     dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
#                     dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
#          fit_qp_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_offset = map(fit_qp_offset, tidy),
#                     pred_qp_offset = map(fit_qp_offset, augment),
#                     qual_qp_offset = map(fit_qp_offset, glance),
#                     offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
#                     offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
#                     offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
#                     offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
#                     offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
#          fit_p_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
#                     pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
#                     qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
#                     dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
#                     dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
#          fit_qp_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
#                     pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
#                     qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
#                     taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
#                     taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
#                     taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
#                     taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
#                     taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
#          fit_p_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
#                     pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
#                     qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
#                     dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
#                     dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
#          fit_qp_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
#                     pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
#                     qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
#                     taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
#                     taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
#                     taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
#                     taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
#                     taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
#          fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
#                     pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
#                     qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
#                     dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
#                     dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
#          fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
#                     pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
#                     qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
#                     taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
#   select(HyPe, data,
#          offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
#          taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
#          taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
#          taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
#         # fit_chngpt = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ abs_Latitude,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#         #             param_chngpt = map(fit_chngpt, "coefficients"),
#         #             qual_chngpt = map(fit_chngpt, "vcov"),
#         #  fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#         #             param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
#         #             qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
#         #             fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
#         #             line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
#         #  
#         #  fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
#         #             param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
#         #             qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
#         #             fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
#         #             line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
#         #  fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
#         #             param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
#         #             qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
#         #             fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
#         #             line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))
# 
# saveRDS(HyPeLatNoZero, file = file.path(DataProcessed, "HyPeLatNoZero.Rds"))

```

```{r HyPeLatProk, include = FALSE}
# HyPeLatProk <- MergedData %>% 
#   filter(!is.na(HyPe)) %>%
#   filter(GeneModels_count != 0)%>% 
#   select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, HyPe, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, HyPe_count)  %>%
#   unique() %>%
#   nest(data = -HyPe) %>%
#   mutate(fit_p_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_offset = map(fit_p_offset, tidy),
#                     pred_p_offset = map(fit_p_offset, augment),
#                     qual_p_offset = map(fit_p_offset, glance),
#                     dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
#                     dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
#          fit_qp_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_offset = map(fit_qp_offset, tidy),
#                     pred_qp_offset = map(fit_qp_offset, augment),
#                     qual_qp_offset = map(fit_qp_offset, glance),
#                     offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
#                     offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
#                     offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
#                     offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
#                     offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
#          fit_p_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
#                     pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
#                     qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
#                     dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
#                     dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
#          fit_qp_taxa_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
#                     pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
#                     qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
#                     taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
#                     taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
#                     taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
#                     taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
#                     taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
#          fit_p_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
#                     pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
#                     qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
#                     dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
#                     dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
#          fit_qp_taxaome_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
#                     pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
#                     qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
#                     taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
#                     taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
#                     taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
#                     taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
#                     taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
#          fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
#                     pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
#                     qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
#                     dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
#                     dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
#          fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$HyPe_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
#                     pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
#                     qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
#                     taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
#   select(HyPe, data,
#          offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
#          taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
#          taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
#          taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
#          # fit_chngpt = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ abs_Latitude,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt = map(fit_chngpt, "coefficients"),
#          #            qual_chngpt = map(fit_chngpt, "vcov"),
#          # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
#          #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
#          #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
#          #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
#          # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
#          #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
#          #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
#          #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
#          # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = HyPe_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
#          #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
#          #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
#          #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))
# 
# saveRDS(HyPeLatProk, file = file.path(DataProcessed, "HyPeLatProk.Rds"))
```



## SupOx {}

```{r SupOxLat, include = FALSE}
# SupOxLat <- MergedData %>% 
#   filter(!is.na(SupOx),
#          Taxa != c("Prokaryote"),) %>%
#   filter(GeneModels_count != 0)%>% #This is because of introducing exposure
#   select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, SupOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, SupOx_count)  %>%
#   unique() %>%
#   nest(data = -SupOx) %>%
#   mutate(fit_p_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_offset = map(fit_p_offset, tidy),
#                     pred_p_offset = map(fit_p_offset, augment),
#                     qual_p_offset = map(fit_p_offset, glance),
#                     dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
#                     dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
#          fit_qp_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_offset = map(fit_qp_offset, tidy),
#                     pred_qp_offset = map(fit_qp_offset, augment),
#                     qual_qp_offset = map(fit_qp_offset, glance),
#                     offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
#                     offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
#                     offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
#                     offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
#                     offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
#          fit_p_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
#                     pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
#                     qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
#                     dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
#                     dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
#          fit_qp_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
#                     pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
#                     qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
#                     taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
#                     taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
#                     taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
#                     taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
#                     taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
#          fit_p_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
#                     pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
#                     qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
#                     dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
#                     dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
#          fit_qp_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
#                     pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
#                     qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
#                     taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
#                     taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
#                     taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
#                     taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
#                     taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
#          fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
#                     pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
#                     qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
#                     dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
#                     dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
#          fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
#                     pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
#                     qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
#                     taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
#   select(SupOx, data,
#          offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
#          taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
#          taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
#          taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
#          # fit_chngpt = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ abs_Latitude,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt = map(fit_chngpt, "coefficients"),
#          #            qual_chngpt = map(fit_chngpt, "vcov"),
#          # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
#          #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
#          #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
#          #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
#          # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
#          #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
#          #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
#          #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
#          # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
#          #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
#          #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
#          #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))
# 
# saveRDS(SupOxLat, file = file.path(DataProcessed, "SupOxLat.Rds"))
```

```{r SupOxLatNoZero, include = FALSE}
# SupOxLatNoZero <- MergedData %>% 
#   filter(Taxa != c("Prokaryote"),
#          !is.na(SupOx), 
#          SupOx_count != 0) %>%
#   filter(GeneModels_count != 0)%>% #This is because of introducing exposure
#   select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, SupOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, SupOx_count)  %>%
#   unique() %>%
#   nest(data = -SupOx) %>%
#   mutate(fit_p_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_offset = map(fit_p_offset, tidy),
#                     pred_p_offset = map(fit_p_offset, augment),
#                     qual_p_offset = map(fit_p_offset, glance),
#                     dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
#                     dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
#          fit_qp_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_offset = map(fit_qp_offset, tidy),
#                     pred_qp_offset = map(fit_qp_offset, augment),
#                     qual_qp_offset = map(fit_qp_offset, glance),
#                     offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
#                     offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
#                     offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
#                     offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
#                     offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
#          fit_p_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
#                     pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
#                     qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
#                     dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
#                     dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
#          fit_qp_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
#                     pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
#                     qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
#                     taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
#                     taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
#                     taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
#                     taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
#                     taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
#          fit_p_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
#                     pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
#                     qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
#                     dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
#                     dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
#          fit_qp_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
#                     pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
#                     qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
#                     taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
#                     taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
#                     taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
#                     taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
#                     taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
#          fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
#                     pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
#                     qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
#                     dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
#                     dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
#          fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
#                     pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
#                     qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
#                     taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
#   select(SupOx, data,
#          offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
#          taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
#          taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
#          taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
#          # fit_chngpt = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ abs_Latitude,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt = map(fit_chngpt, "coefficients"),
#          #            qual_chngpt = map(fit_chngpt, "vcov"),
#          # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
#          #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
#          #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
#          #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
#          # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
#          #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
#          #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
#          #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
#          # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
#          #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
#          #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
#          #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))
# 
# saveRDS(SupOxLatNoZero, file = file.path(DataProcessed, "SupOxLatNoZero.Rds"))


```

```{r SupOxLatProk, include = FALSE}
# SupOxLatProk <- MergedData %>% 
#   filter(!is.na(SupOx)) %>%
#   filter(GeneModels_count != 0)%>% #This is because of introducing exposure
#   select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, SupOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, SupOx_count)  %>%
#   unique() %>%
#   nest(data = -SupOx) %>%
#   mutate(fit_p_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_offset = map(fit_p_offset, tidy),
#                     pred_p_offset = map(fit_p_offset, augment),
#                     qual_p_offset = map(fit_p_offset, glance),
#                     dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
#                     dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
#          fit_qp_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_offset = map(fit_qp_offset, tidy),
#                     pred_qp_offset = map(fit_qp_offset, augment),
#                     qual_qp_offset = map(fit_qp_offset, glance),
#                     offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
#                     offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
#                     offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
#                     offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
#                     offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
#          fit_p_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
#                     pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
#                     qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
#                     dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
#                     dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
#          fit_qp_taxa_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
#                     pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
#                     qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
#                     taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
#                     taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
#                     taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
#                     taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
#                     taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
#          fit_p_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
#                     pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
#                     qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
#                     dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
#                     dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
#          fit_qp_taxaome_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
#                     pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
#                     qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
#                     taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
#                     taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
#                     taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
#                     taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
#                     taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
#          fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
#                     pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
#                     qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
#                     dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
#                     dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
#          fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$SupOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
#                     pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
#                     qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
#                     taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
#   select(SupOx, data,
#          offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
#          taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
#          taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
#          taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
#          # fit_chngpt = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ abs_Latitude,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt = map(fit_chngpt, "coefficients"),
#          #            qual_chngpt = map(fit_chngpt, "vcov"),
#          # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
#          #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
#          #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
#          #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
#          # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
#          #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
#          #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
#          #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
#          # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = SupOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
#          #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
#          #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
#          #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))
# 
# saveRDS(SupOxLatProk, file = file.path(DataProcessed, "SupOxLatProk.Rds"))
```

## NitOx {}

```{r NitOxLat, include = FALSE}
# NitOxLat <- MergedData %>% 
#   filter(Taxa != c("Prokaryote"),
#          !is.na(NitOx)) %>%
#   filter(GeneModels_count != 0)%>% #This is because of introducing exposure
#   select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, NitOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, NitOx_count)  %>%
#   unique() %>%
#   nest(data = -NitOx) %>%
#   mutate(fit_p_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_offset = map(fit_p_offset, tidy),
#                     pred_p_offset = map(fit_p_offset, augment),
#                     qual_p_offset = map(fit_p_offset, glance),
#                     dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
#                     dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
#          fit_qp_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_offset = map(fit_qp_offset, tidy),
#                     pred_qp_offset = map(fit_qp_offset, augment),
#                     qual_qp_offset = map(fit_qp_offset, glance),
#                     offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
#                     offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
#                     offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
#                     offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
#                     offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
#          fit_p_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
#                     pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
#                     qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
#                     dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
#                     dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
#          fit_qp_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
#                     pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
#                     qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
#                     taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
#                     taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
#                     taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
#                     taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
#                     taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
#          fit_p_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
#                     pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
#                     qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
#                     dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
#                     dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
#          fit_qp_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
#                     pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
#                     qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
#                     taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
#                     taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
#                     taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
#                     taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
#                     taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
#          fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
#                     pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
#                     qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
#                     dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
#                     dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
#          fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
#                     pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
#                     qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
#                     taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
#   select(NitOx, data,
#          offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
#          taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
#          taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
#          taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
#          # fit_chngpt = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ abs_Latitude,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt = map(fit_chngpt, "coefficients"),
#          #            qual_chngpt = map(fit_chngpt, "vcov"),
#          # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
#          #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
#          #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
#          #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
#          # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
#          #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
#          #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
#          #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
#          # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
#          #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
#          #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
#          #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))
# 
# saveRDS(NitOxLat, file = file.path(DataProcessed, "NitOxLat.Rds"))
```

```{r NitOxLatNoZero, include = FALSE}
# NitOxLatNoZero <- MergedData %>% 
#   filter(Taxa != c("Prokaryote"),
#          !is.na(NitOx), 
#          NitOx_count != 0) %>%
#   filter(GeneModels_count != 0)%>% #This is because of introducing exposure
#   select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, NitOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, NitOx_count)  %>%
#   unique() %>%
#   nest(data = -NitOx) %>%
#   mutate(fit_p_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_offset = map(fit_p_offset, tidy),
#                     pred_p_offset = map(fit_p_offset, augment),
#                     qual_p_offset = map(fit_p_offset, glance),
#                     dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
#                     dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
#          fit_qp_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_offset = map(fit_qp_offset, tidy),
#                     pred_qp_offset = map(fit_qp_offset, augment),
#                     qual_qp_offset = map(fit_qp_offset, glance),
#                     offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
#                     offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
#                     offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
#                     offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
#                     offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
#          fit_p_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
#                     pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
#                     qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
#                     dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
#                     dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
#          fit_qp_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
#                     pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
#                     qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
#                     taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
#                     taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
#                     taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
#                     taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
#                     taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
#          fit_p_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
#                     pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
#                     qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
#                     dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
#                     dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
#          fit_qp_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
#                     pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
#                     qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
#                     taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
#                     taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
#                     taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
#                     taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
#                     taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
#          fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
#                     pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
#                     qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
#                     dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
#                     dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
#          fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
#                     pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
#                     qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
#                     taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
#   select(NitOx, data,
#          offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
#          taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
#          taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
#          taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
#          # fit_chngpt = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ abs_Latitude,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt = map(fit_chngpt, "coefficients"),
#          #            qual_chngpt = map(fit_chngpt, "vcov"),
#          # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
#          #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
#          #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
#          #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
#          # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
#          #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
#          #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
#          #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
#          # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
#          #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
#          #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
#          #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))
# 
# saveRDS(NitOxLatNoZero, file = file.path(DataProcessed, "NitOxLatNoZero.Rds"))

```

```{r NitOxLatProk, include = FALSE}
# NitOxLatProk <- MergedData %>% 
#   filter(!is.na(NitOx)) %>%
#   filter(GeneModels_count != 0)%>% #This is because of introducing exposure
#   select(FileName, Genus, species, Strain, Name, Ome, Taxa, Rad1_um, Rad2_um, Rad3_um, Flagella, GenomeSize_mbp, GeneModels_count, Latitude, Longitude, Marine, NitOx, PennateCentric, SA_um2, Volume_um3, SAVol_um, Radius_um, log_Radius_um, log_GenomeSize_mbp, log_GeneModels_count, abs_Latitude, log_Volume_um3, log_SA_um2, log_SAVol_um, NitOx_count)  %>%
#   unique() %>%
#   nest(data = -NitOx) %>%
#   mutate(fit_p_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_offset = map(fit_p_offset, tidy),
#                     pred_p_offset = map(fit_p_offset, augment),
#                     qual_p_offset = map(fit_p_offset, glance),
#                     dispersion_p_offset = map(fit_p_offset, AER::dispersiontest),
#                     dispersion_p_offset_tidy = map(dispersion_p_offset, tidy),
#          fit_qp_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude , offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_offset = map(fit_qp_offset, tidy),
#                     pred_qp_offset = map(fit_qp_offset, augment),
#                     qual_qp_offset = map(fit_qp_offset, glance),
#                     offset_model_regression = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ param_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ param_qp_offset)),
#                     offset_model = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ fit_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ fit_qp_offset)),
#                     offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_offset)),
#                     offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_offset)),
#                     offset_regression_type = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     offset_model_pvalue = case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_offset, anova, test = "F")),
#          fit_p_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxa_offset = map(fit_p_taxa_offset, tidy),
#                     pred_p_taxa_offset = map(fit_p_taxa_offset, augment),
#                     qual_p_taxa_offset = map(fit_p_taxa_offset, glance),
#                     dispersion_p_taxa_offset = map(fit_p_taxa_offset, AER::dispersiontest),
#                     dispersion_p_taxa_offset_tidy = map(dispersion_p_taxa_offset, tidy),
#          fit_qp_taxa_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxa_offset = map(fit_qp_taxa_offset, tidy),
#                     pred_qp_taxa_offset = map(fit_qp_taxa_offset, augment),
#                     qual_qp_taxa_offset = map(fit_qp_taxa_offset, glance),
#                     taxa_offset_model_regression = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ param_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxa_offset)),
#                     taxa_offset_regression_type = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxa_offset_model = (case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxa_offset,
#                                                         map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxa_offset)),
#                     taxa_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxa_offset)),
#                     taxa_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxa_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxa_offset)),
#                     taxa_offset_model_pvalue = case_when(map(dispersion_p_taxa_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxa_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxa_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxa_offset, anova, test = "F")),
#          fit_p_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaome_offset = map(fit_p_taxaome_offset, tidy),
#                     pred_p_taxaome_offset = map(fit_p_taxaome_offset, augment),
#                     qual_p_taxaome_offset = map(fit_p_taxaome_offset, glance),
#                     dispersion_p_taxaome_offset = map(fit_p_taxaome_offset, AER::dispersiontest),
#                     dispersion_p_taxaome_offset_tidy = map(dispersion_p_taxaome_offset, tidy),
#          fit_qp_taxaome_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaome_offset = map(fit_qp_taxaome_offset, tidy),
#                     pred_qp_taxaome_offset = map(fit_qp_taxaome_offset, augment),
#                     qual_qp_taxaome_offset = map(fit_qp_taxaome_offset, glance),
#                     taxaome_offset_model_regression = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaome_offset)),
#                     taxaome_offset_regression_type = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaome_offset_model = (case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaome_offset,
#                                                         map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaome_offset)),
#                     taxaome_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaome_offset)),
#                     taxaome_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaome_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaome_offset)),
#                     taxaome_offset_model_pvalue = case_when(map(dispersion_p_taxaome_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaome_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaome_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaome_offset, anova, test = "F")),
#          fit_p_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = poisson(link = "log")), otherwise = NULL)),
#                     param_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, tidy),
#                     pred_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, augment),
#                     qual_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, glance),
#                     dispersion_p_taxaomeflag_offset = map(fit_p_taxaomeflag_offset, AER::dispersiontest),
#                     dispersion_p_taxaomeflag_offset_tidy = map(dispersion_p_taxaomeflag_offset, tidy),
#          fit_qp_taxaomeflag_offset = map(data, possibly(~glm(.$NitOx_count ~ .$abs_Latitude + Taxa + Ome + Flagella, offset = log(GeneModels_count), data = ., family = quasipoisson(link = "log")), otherwise = NULL)),
#                     param_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, tidy),
#                     pred_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, augment),
#                     qual_qp_taxaomeflag_offset = map(fit_qp_taxaomeflag_offset, glance),
#                     taxaomeflag_offset_model_regression = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ param_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ param_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_regression_type = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ "poisson",
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ "quasipoisson")),
#                     taxaomeflag_offset_model = (case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ fit_p_taxaomeflag_offset,
#                                                         map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ fit_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pred = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ pred_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ pred_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_qual = (case_when(map(dispersion_p_offset_tidy, "p.value")  > 0.05 ~ qual_p_taxaomeflag_offset,
#                                                         map(dispersion_p_offset_tidy, "p.value") <= 0.05 ~ qual_qp_taxaomeflag_offset)),
#                     taxaomeflag_offset_model_pvalue = case_when(map(dispersion_p_taxaomeflag_offset_tidy, "p.value")  > 0.05 ~ map(fit_p_taxaomeflag_offset, anova, test = "Chisq"),
#                                                     map(dispersion_p_taxaomeflag_offset_tidy, "p.value") <= 0.05 ~ map(fit_qp_taxaomeflag_offset, anova, test = "F"))) %>%
#   select(NitOx, data,
#          offset_model_regression, offset_model, offset_model_pred, offset_model_qual, offset_regression_type, offset_model_pvalue,
#          taxa_offset_model_regression, taxa_offset_model, taxa_offset_model_pred, taxa_offset_model_qual, taxa_offset_regression_type, taxa_offset_model_pvalue,
#          taxaome_offset_model_regression, taxaome_offset_model, taxaome_offset_model_pred, taxaome_offset_model_qual, taxaome_offset_regression_type, taxaome_offset_model_pvalue,
#          taxaomeflag_offset_model_regression, taxaomeflag_offset_model, taxaomeflag_offset_model_pred, taxaomeflag_offset_model_qual, taxaomeflag_offset_regression_type, taxaomeflag_offset_model_pvalue)
#          # fit_chngpt = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ abs_Latitude,    data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt = map(fit_chngpt, "coefficients"),
#          #            qual_chngpt = map(fit_chngpt, "vcov"),
#          # fit_chngpt_taxa = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "gaussian"), otherwise = NULL)),
#          #            param_chngpt_taxa = map(fit_chngpt_taxa, "coefficients"),
#          #            qual_chngpt_taxa = map(fit_chngpt_taxa, "vcov"),
#          #            fitted_chngpt_taxa = map(fit_chngpt_taxa,"best.fit"),
#          #            line_chngpt_taxa = map(fitted_chngpt_taxa,"fitted.values"),
#          # fit_chngpt_taxa_p = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "poisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_p = map(fit_chngpt_taxa_p, "coefficients"),
#          #            qual_chngpt_taxa_p = map(fit_chngpt_taxa_p, "vcov"),
#          #            fitted_chngpt_taxa_p = map(fit_chngpt_taxa_p,"best.fit"),
#          #            line_chngpt_taxa_p = map(fitted_chngpt_taxa_p,"fitted.values"),
#          # fit_chngpt_taxa_qp = map(data, possibly(~chngptm(formula.1 = NitOx_count ~ 1, formula.2 = ~ (abs_Latitude+Taxa),  data = ., type = threshold_type, family = "quasipoisson"), otherwise = NULL)),
#          #            param_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "coefficients"),
#          #            qual_chngpt_taxa_qp = map(fit_chngpt_taxa_qp, "vcov"),
#          #            fitted_chngpt_taxa_qp = map(fit_chngpt_taxa_qp,"best.fit"),
#          #            line_chngpt_taxa_qp = map(fitted_chngpt_taxa_qp,"fitted.values"))
# 
# saveRDS(NitOxLatProk, file = file.path(DataProcessed, "NitOxLatProk.Rds"))
```
